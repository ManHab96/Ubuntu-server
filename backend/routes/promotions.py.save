from fastapi import APIRouter, HTTPException, Depends
from typing import List, Optional
from datetime import datetime

from database import media_files_collection
from auth import get_current_user
from models import MediaFile

router = APIRouter(prefix="/api/promotions", tags=["promotions"])

@router.get("/", response_model=List[MediaFile])
async def get_promotions(
    agency_id: str,
    current_user: dict = Depends(get_current_user)
):
    promotions = await media_files_collection.find(
        {
            "agency_id": agency_id,
            "category": "promotion"
        },
        {"_id": 0}
    ).to_list(1000)

    return [MediaFile(**promo) for promo in promotions]


@router.get("/{file_id}", response_model=MediaFile)
async def get_promotion(
    file_id: str,
    current_user: dict = Depends(get_current_user)
):
    promo = await media_files_collection.find_one(
        {
            "id": file_id,
            "category": "promotion"
        },
        {"_id": 0}
    )

    if not promo:
        raise HTTPException(404, "Promotion not found")

    return promo

@router.patch("/{file_id}")
async def update_promotion(
    file_id: str,
    data: PromotionUpdate,
    current_user: dict = Depends(get_current_user)
):
    result = await media_files_collection.update_one(
        {
            "id": file_id,
            "category": "promotion"
        },
        {
            "$set": data.model_dump(exclude_unset=True)
        }
    )

    if result.matched_count == 0:
        raise HTTPException(404, "Promotion not found")

    return {"message": "Promotion updated"}


@router.patch("/{file_id}/toggle")
async def toggle_promotion(
    file_id: str,
    is_active: bool,
    current_user: dict = Depends(get_current_user)
):
    result = await media_files_collection.update_one(
        {
            "id": file_id,
            "category": "promotion"
        },
        {"$set": {"is_active": is_active}}
    )

    if result.matched_count == 0:
        raise HTTPException(404, "Promotion not found")

    return {"message": "Promotion status updated"}
